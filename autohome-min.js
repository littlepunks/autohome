"use strict";var express=require("express");var app=express();var http=require("http").Server(app);var io=require("socket.io")(http);var request=require("request");var colors=require("colors");const fs=require("fs");const geoip=require("geoip-lite");require("dotenv").config();const{styleText:styleText}=require("node:util");const MS=require("./modules/constants.js");const rrdtool="rrdtool.exe";const TempsRRDFile="./temps.rrd";const makeGraphCmdFile="make-graph.cmd";const autohomeLogFile="./autohome.log";const enableRRD=true;const spawn=require("child_process").spawn;const enableWEMO=false;const enableTPLINK=false;const enableTUYA=false;app.use(express.urlencoded({extended:false}));app.use(express.json());let plugs=[];var DEBUG=false;var conf={};const SF="./STG.json";const SCI=3e5;const RDI=3e5;readSTG();var rN="";var rS="";var rMT="";var rA="";var rST="";var rP="";function updateStatuses(){getOutsidewva()}function startTimer(){setTimeout(stopTimer,conf.polling.interval*1e3)}function stopTimer(){updateStatuses();startTimer()}function startSensorCT(){setTimeout(stopSensorCT,SCI)}function stopSensorCT(){if(!gw.isOpen){gwErrFlag=true}if(gwErrFlag){}var tnow=(new Date).getTime();conf.mys.sensorNs.forEach((s=>{let oldStatus=s.contact_status;let delta=tnow-s.updated;if(delta>s.freq*1e3*2){s.contact_status="2"}else if(delta>s.freq*1e3){s.contact_status="1"}else{s.contact_status="0"}if(oldStatus!=s.contact_status){io.emit("SMv2",JSON.stringify(s))}}));startSensorCT()}startSensorCT();function startTT(){setTimeout(stopTT,RDI)}function stopTT(){var args="N";var getSensor;["Outside","Tom"].forEach((s=>{getSensor=conf.mys.sensorNs.find((sensor=>sensor.name==s));args+=":"+(getSensor!==undefined?getSensor.value:"U")}));const bat=spawn(rrdtool,["update",TempsRRDFile,args]);bat.stdout.on("data",(data=>{}));bat.stderr.on("data",(data=>{}));bat.on("exit",(code=>{if(code!=0){}const bat2=spawn("cmd.exe",["/c",makeGraphCmdFile]);bat2.stdout.on("data",(data=>{}));bat2.stderr.on("data",(data=>{}));bat2.on("exit",(code=>{if(code!=0){}}))}));startTT();writeSTG()}if(enableRRD){startTT()}startTimer();function readSTG(){const fs=require("fs");try{var fileContents=fs.readFileSync(SF,"utf-8")}catch(err){if(err.code==="ENOENT"){}throw err}try{conf=JSON.parse(fileContents)}catch(err){throw err}}function writeSTG(){var fs=require("fs");fs.writeFile(SF,JSON.stringify(conf,null,2),"utf-8",(function(error){if(error){}else{}}))}function writeSTGSync(){var fs=require("fs");try{fs.writeFileSync(SF,JSON.stringify(conf,null,2),"utf-8")}catch(err){}}process.on("SIGINT",(()=>{writeSTGSync();process.exit(0)}));const{SerialPort:SerialPort}=require("serialport");const gw=new SerialPort({path:conf.mys.comport,baudRate:conf.mys.baud,autoOpen:conf.mys.autoopen});var gwErrFlag=true;gw.open();gw.on("open",(function(){gwErrFlag=false})).on("data",(function(rd){appendData(rd.toString());gwErrFlag=false})).on("end",(function(){gwErrFlag=true})).on("error",(function(){gwErrFlag=true}));function gwWrite(msg,logtxt){gw.write(msg+"\n",(function(err){if(err){return}}))}function appendData(str){var pos=0;var appendedString="";while(str.charAt(pos)!="\n"&&pos<str.length){appendedString=appendedString+str.charAt(pos);pos++}if(str.charAt(pos)=="\n"){decode(appendedString.trim())}if(pos<str.length){appendData(str.substr(pos+1,str.length-pos-1))}}function getOutsidewva(){request(conf.wva.externalTempURL,(function(error,response,body){if(error){}else{var obj=JSON.parse(body);if(obj instanceof Error||!obj.main){}else{decode("208;0;"+MS.C_SET+";0;"+MS.V_IMAGE+";"+"speed_1w.png")}writeSTG()}}))}function dateTimeString(){const now=new Date;const withLead0=value=>String(value).padStart(2,"0");return`${withLead0(now.getDate())}-${withLead0(now.getMonth()+1)}-${now.getFullYear()} `+`${withLead0(now.getHours())}:${withLead0(now.getMinutes())}:${withLead0(now.getSeconds())}`}function convertTimestampToTime(timestamp){const date=new Date(timestamp*1e3);const hours=date.getHours();const minutes=date.getMinutes();const formattedMinutes=String(minutes).padStart(2,"0");const isPM=hours>=12;const adjustedHours=hours%12||12;const ampm=isPM?"PM":"AM";return`${adjustedHours}:${formattedMinutes} ${ampm}`}function decode(msg){const msgs=msg.toString().split(";");if(msgs.length<6){return 1}const[rN,rS,rMT,rA,rST,payload]=msgs;const trimmed=payload.trim();let rP=isNaN(+trimmed)?trimmed:+trimmed;switch(+rMT){case MS.C_PRESENTATION:case MS.C_REQ:break;case MS.C_SET:switch(rST){case MS.V_TEMP:var getSensor=conf.mys.sensorNs.find((sensor=>sensor.id==rN));if(getSensor!==undefined){var oldVal=getSensor.value;getSensor.updated=(new Date).getTime();getSensor.value=rP;getSensor.contact_status="0";io.emit("SMv2",JSON.stringify(getSensor));if(rN=="25"&&rP!=oldVal){decode("105;0;"+MS.C_SET+";0;"+MS.V_SWITCH+";"+rP);processButton("105")}}else{}if(rN=="14"){checkSensor(getSensor)}break;case MS.V_STATUS:break;default:}break;case MS.C_INTERNAL:switch(rST){case MS.I_BATTERY_LEVEL:break;case MS.I_LOG_MESSAGE:break;case MS.I_GATEWAY_READY:break;default:}break;case MS.C_BROADCAST:break;default:}}function checkSensor(sensor){function parseThreshold(threshold){if(typeof threshold==="number"){return{operator:"=",number:threshold}}const match=threshold.match(/^([<>])(-?\d+)$/);return match?{operator:match[1],number:parseFloat(match[2])}:null}const warning=parseThreshold(sensor.warningThreshold);const alarm=parseThreshold(sensor.alarmThreshold);function shouldRaiseAlert(threshold){const{operator:operator,number:number}=threshold;return operator==="="?sensor.value===number:operator==="<"?sensor.value<number:operator===">"?sensor.value>number:false}if(!(shouldRaiseAlert(alarm)||shouldRaiseAlert(warning))&&sensor.alarmState!==0){const msgBody=`INFO: ${sensor.name} value (${sensor.value}) is back to normal!`;sendEmail("dave.jacobsen@gmail.com",`${sensor.name} Normal`,msgBody);sensor.alarmState=0}if(shouldRaiseAlert(alarm)&&sensor.alarmState!==2){const msgBody=`ALARM: ${sensor.name} value (${sensor.value}) exceeded threshold! (${alarm.operator}${alarm.number})`;sendEmail("dave.jacobsen@gmail.com",`${sensor.name} Alarm`,msgBody);sensor.alarmState=2}else if(shouldRaiseAlert(warning)&&sensor.alarmState!==1){const msgBody=`WARNING: ${sensor.name} value (${sensor.value}) near critical value! (${alarm.operator}${alarm.number})`;sendEmail("dave.jacobsen@gmail.com",`${sensor.name} Warning`,msgBody);sensor.alarmState=1}}app.get("/",(function(req,res){var sendFileName=__dirname+"/dash.html";var geo=geoip.lookup(req.ip);if(geo){if(geo.country=="NZ"||geo.country=="AU"){}else{sendFileName=__dirname+"/sorry.html"}}res.sendFile(sendFileName)}));app.get("/test",(function(req,res){res.sendFile(__dirname+"/dash-modern.html")}));app.get("/constants-client.js",(function(req,res){res.sendFile(__dirname+"/constants-client.js")}));app.get("/sensors",(function(req,res){var sensorJSON=JSON.stringify(conf.mys.sensorNs);res.send(sensorJSON)}));app.get("/graphs",(function(req,res){res.sendFile(__dirname+"/graphs.html")}));app.use(express.static("images"));app.use(express.static("js"));app.use(express.static("css"));io.on("connection",(function(socket){socket.on("ClientMsg",(function(msg){msg=msg.replace(/(\r\n|\n|\r)/gm,"");var msgs=msg.toString().split(";");if(msgs[0]=="redraw"){conf.mys.sensorNs.forEach((s=>{io.emit("SMv2",JSON.stringify(s))}));io.emit("",JSON.stringify(conf.mys.sensorNs))}else if(msgs[0]=="init"){io.emit("sensors",JSON.stringify(conf.mys.sensorNs))}else if(msgs[0]=="BUT"||msgs[0]=="CHK"){processButton(msgs[1])}else{}}));socket.on("disconnect",(function(){}))}));http.listen(8080,(function(){}));function processButton(butID){const sensor=conf.mys.sensorNs.find((s=>s.id==butID));if(!sensor){return}updateSensorState(sensor);handleSpecialActions(butID,sensor.value)}function updateSensorState(sensor){sensor.updated=Date.now();sensor.value=sensor.value==="0"?"1":"0";sensor.contact_status="0";io.emit("SMv2",JSON.stringify(sensor))}function handleSpecialActions(butID,value){const specialActions={12:()=>controlSonoffSwitch(value),103:()=>toggleDebug(value),997:()=>shutdownApplication(),998:()=>triggerSTGSave()};specialActions[butID]?.()}function handleSmartSwitch(butID,value){const plug=plugs.find((p=>p.id==butID));if(!plug){return}const smartSwitchHandlers={tplink:()=>client.getPlug({host:plug.host}).setPowerState(value==="1"),tuya:()=>toggleTuyaSwitch(value)};smartSwitchHandlers[plug.type]?.()||{}}function controlSonoffSwitch(value){request(`http://192.168.1.87/control?cmd=GPIO,12,${value}`,(error=>{if(error){}}))}function toggleDebug(value){DEBUG=value==="1"}function shutdownApplication(){writeSTGSync();process.exit(0)}function triggerSTGSave(){writeSTG();decode(`998;0;${MS.C_SET};0;${MS.V_SWITCH};0`)}function toggleTuyaSwitch(value){try{tuyaDev.set({set:value==="1"}).then((()=>{}))}catch(error){}}